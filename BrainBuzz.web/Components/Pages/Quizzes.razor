@page "/quizzes"
@layout MainLayout
@rendermode InteractiveServer
@inject IQuizService QuizService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>Quizzes - BrainBuzz</PageTitle>

<!-- Quizzes Content -->
<div class="content-container">
     <div class="space-y-6">
          <div class="mb-8">
               <h1 class="text-3xl font-bold text-gray-900 mb-2">Available Quizzes</h1>
               <p class="text-gray-600">Choose a quiz to test your knowledge and track your progress.</p>
          </div>

          <div class="space-y-6">
               @if (isLoading)
               {
                    <LoadingSkeleton Type="LoadingSkeleton.SkeletonType.List" Count="6" />
               }
               else if (!quizzes.Any())
               {
                    <div class="modern-empty-state">
                         <div class="empty-icon">
                              <i class="fas fa-book"></i>
                         </div>
                         <h4>No Quizzes Available</h4>
                         <p>Check back later for new quizzes to test your knowledge.</p>
                    </div>
               }
               else
               {
                    <!-- Filter and Search -->
                    <div class="content-card mb-6">
                         <div class="dashboard-card-header">
                              <div class="header-content">
                                   <div class="header-icon">
                                        <i class="fas fa-search"></i>
                                   </div>
                                   <div class="header-text">
                                        <h3 class="header-title">Find Quizzes</h3>
                                        <p class="header-subtitle">Search and filter available quizzes</p>
                                   </div>
                              </div>
                         </div>
                         <div class="card-body">
                              <div class="flex flex-col md:flex-row gap-4">
                                   <div class="flex-1">
                                        <input type="text"
                                               @bind="searchTerm"
                                               @oninput="FilterQuizzes"
                                               placeholder="Search quizzes..."
                                               class="form-input" />
                                   </div>
                                   <div class="flex gap-2">
                                        <select @onchange="OnCategoryChanged" class="form-input">
                                             <option value="">All Categories</option>
                                             <option value="General Knowledge" selected="@(selectedCategory == "General Knowledge")">General Knowledge</option>
                                             <option value="Science" selected="@(selectedCategory == "Science")">Science</option>
                                             <option value="Technology" selected="@(selectedCategory == "Technology")">Technology</option>
                                             <option value="History" selected="@(selectedCategory == "History")">History</option>
                                             <option value="Mathematics" selected="@(selectedCategory == "Mathematics")">Mathematics</option>
                                        </select>
                                        <select @onchange="OnDifficultyChanged" class="form-input">
                                             <option value="">All Levels</option>
                                             <option value="Easy" selected="@(selectedDifficulty == "Easy")">Easy</option>
                                             <option value="Medium" selected="@(selectedDifficulty == "Medium")">Medium</option>
                                             <option value="Hard" selected="@(selectedDifficulty == "Hard")">Hard</option>
                                        </select>
                                   </div>
                              </div>
                         </div>
                    </div>

                    <!-- Quizzes Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                         @foreach (var quiz in filteredQuizzes)
                         {
                              <div class="card hover:shadow-lg transition-all duration-300">
                                   <div class="card-body">
                                        <div class="flex items-start justify-between mb-4">
                                             <div class="flex-1">
                                                  <h3 class="text-lg font-semibold text-gray-900 mb-2">@quiz.QuizName</h3>
                                                  <p class="text-sm text-gray-600 mb-3">@quiz.Description</p>
                                             </div>
                                             <span class="badge @GetDifficultyBadgeClass(quiz.Difficulty)">@quiz.Difficulty</span>
                                        </div>

                                        <div class="space-y-2 mb-4">
                                             <div class="flex items-center text-sm text-gray-600">
                                                  <i class="fas fa-question-circle w-4 h-4 mr-2"></i>
                                                  <span>@quiz.TotalQuestions questions</span>
                                             </div>
                                             <div class="flex items-center text-sm text-gray-600">
                                                  <i class="fas fa-clock w-4 h-4 mr-2"></i>
                                                  <span>@quiz.TimeLimit minutes</span>
                                             </div>
                                             <div class="flex items-center text-sm text-gray-600">
                                                  <i class="fas fa-tag w-4 h-4 mr-2"></i>
                                                  <span>@quiz.Category</span>
                                             </div>
                                        </div>

                                        <div class="flex gap-2">
                                             <a href="/quiz/@(quiz?.QuizId ?? 0)" class="btn btn-primary flex-1">
                                                  <i class="fas fa-play mr-2"></i>
                                                  Start Quiz
                                             </a>
                                             <button @onclick="() => ShowQuizDetails(quiz)" class="btn btn-outline">
                                                  <i class="fas fa-info-circle"></i>
                                             </button>
                                        </div>
                                   </div>
                              </div>
                         }
                    </div>

                    @if (!filteredQuizzes.Any() && (quizzes.Any()))
                    {
                         <div class="modern-empty-state">
                              <div class="empty-icon">
                                   <i class="fas fa-search"></i>
                              </div>
                              <h4>No Quizzes Found</h4>
                              <p>Try adjusting your search criteria or filters.</p>
                              <button @onclick="ClearFilters" class="empty-state-btn">
                                   <i class="fas fa-times"></i>
                                   <span>Clear Filters</span>
                              </button>
                         </div>
                    }
               }
          </div>
     </div>

     <!-- Quiz Details Modal -->
     @if (showModal && selectedQuiz != null)
     {
          <div class="quiz-modal-overlay" @onclick="CloseModal">
               <div class="quiz-modal-content" @onclick:stopPropagation="true">
                    <!-- Modal Header -->
                    <div class="quiz-modal-header">
                         <div class="quiz-modal-title-section">
                              <div class="quiz-modal-icon">
                                   <i class="fas fa-question-circle"></i>
                              </div>
                              <div class="quiz-modal-title-content">
                                   <h3 class="quiz-modal-title">@selectedQuiz.QuizName</h3>
                                   <p class="quiz-modal-subtitle">Ready to test your knowledge?</p>
                              </div>
                         </div>
                         <button @onclick="CloseModal" class="quiz-modal-close">
                              <i class="fas fa-times"></i>
                         </button>
                    </div>

                    <!-- Modal Body -->
                    <div class="quiz-modal-body">
                         <!-- Description Section -->
                         <div class="quiz-modal-section">
                              <div class="quiz-modal-section-header">
                                   <i class="fas fa-info-circle"></i>
                                   <h4 class="quiz-modal-section-title">Description</h4>
                              </div>
                              <p class="quiz-modal-description">@selectedQuiz.Description</p>
                         </div>

                         <!-- Quiz Details Grid -->
                         <div class="quiz-modal-details-grid">
                              <div class="quiz-detail-item">
                                   <div class="quiz-detail-icon">
                                        <i class="fas fa-list-ol"></i>
                                   </div>
                                   <div class="quiz-detail-content">
                                        <div class="quiz-detail-label">Questions</div>
                                        <div class="quiz-detail-value">@selectedQuiz.TotalQuestions</div>
                                   </div>
                              </div>

                              <div class="quiz-detail-item">
                                   <div class="quiz-detail-icon">
                                        <i class="fas fa-clock"></i>
                                   </div>
                                   <div class="quiz-detail-content">
                                        <div class="quiz-detail-label">Time Limit</div>
                                        <div class="quiz-detail-value">@selectedQuiz.TimeLimit min</div>
                                   </div>
                              </div>

                              <div class="quiz-detail-item">
                                   <div class="quiz-detail-icon">
                                        <i class="fas fa-tag"></i>
                                   </div>
                                   <div class="quiz-detail-content">
                                        <div class="quiz-detail-label">Category</div>
                                        <div class="quiz-detail-value">@selectedQuiz.Category</div>
                                   </div>
                              </div>

                              <div class="quiz-detail-item">
                                   <div class="quiz-detail-icon">
                                        <i class="fas fa-signal"></i>
                                   </div>
                                   <div class="quiz-detail-content">
                                        <div class="quiz-detail-label">Difficulty</div>
                                        <div class="quiz-detail-value">@selectedQuiz.Difficulty</div>
                                   </div>
                              </div>
                         </div>
                    </div>

                    <!-- Modal Footer -->
                    <div class="quiz-modal-footer">
                         <button @onclick="CloseModal" class="quiz-modal-btn quiz-modal-btn-secondary">
                              <i class="fas fa-times"></i>
                              <span>Close</span>
                         </button>
                         <a href="/quiz/@selectedQuiz.QuizId" class="quiz-modal-btn quiz-modal-btn-primary">
                              <i class="fas fa-play"></i>
                              <span>Start Quiz</span>
                         </a>
                    </div>
               </div>
          </div>
     }
</div>

@code {
     private bool isLoading = true;
     private List<QuizViewModel> quizzes = new();
     private List<QuizViewModel> filteredQuizzes = new();
     private string searchTerm = "";
     private string selectedCategory = "";
     private string selectedDifficulty = "";
     private bool showModal = false;
     private QuizViewModel? selectedQuiz;

     protected override async Task OnInitializedAsync()
     {
          await LoadQuizzes();
     }

     private async Task LoadQuizzes()
     {
          await Task.Delay(500);
          
          try
          {
               var result = await QuizService.GetAllQuizzesAsync();
               quizzes = result?.ToList() ?? new List<QuizViewModel>();
               filteredQuizzes = quizzes.ToList();
          }
          catch (Exception)
          {
               quizzes = new List<QuizViewModel>();
               filteredQuizzes = new List<QuizViewModel>();
          }
          finally
          {
               isLoading = false;
          }
     }

     private void FilterQuizzes()
     {
          filteredQuizzes = quizzes.Where(quiz =>
              (string.IsNullOrEmpty(searchTerm) ||
               quiz.QuizName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
               quiz.Description.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)) &&
              (string.IsNullOrEmpty(selectedCategory) || quiz.Category == selectedCategory) &&
              (string.IsNullOrEmpty(selectedDifficulty) || quiz.Difficulty == selectedDifficulty)
          ).ToList();
     }

     private void ClearFilters()
     {
          searchTerm = "";
          selectedCategory = "";
          selectedDifficulty = "";
          FilterQuizzes();
     }

     private void OnCategoryChanged(ChangeEventArgs e)
     {
          selectedCategory = e.Value?.ToString() ?? "";
          FilterQuizzes();
     }

     private void OnDifficultyChanged(ChangeEventArgs e)
     {
          selectedDifficulty = e.Value?.ToString() ?? "";
          FilterQuizzes();
     }

     private void ShowQuizDetails(QuizViewModel quiz)
     {
          selectedQuiz = quiz;
          showModal = true;
     }

     private void CloseModal()
     {
          showModal = false;
          selectedQuiz = null;
     }

     private string GetDifficultyBadgeClass(string difficulty)
     {
          return difficulty switch
          {
               "Easy" => "badge-success",
               "Medium" => "badge-warning",
               "Hard" => "badge-error",
               _ => "badge-primary"
          };
     }
}
